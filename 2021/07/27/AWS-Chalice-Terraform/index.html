<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="AWS Chalice is yet another Python serverless framework, like Zappa and the Serverless Framework (what a confusing name). What makes Chalice special is that it has Terraform Support, meaning that it is">
<meta property="og:type" content="article">
<meta property="og:title" content="AWS Chalice + Terraform">
<meta property="og:url" content="https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/index.html">
<meta property="og:site_name" content="Samuel Murillo">
<meta property="og:description" content="AWS Chalice is yet another Python serverless framework, like Zappa and the Serverless Framework (what a confusing name). What makes Chalice special is that it has Terraform Support, meaning that it is">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-07-27T11:33:25.000Z">
<meta property="article:modified_time" content="2021-08-10T02:08:35.931Z">
<meta property="article:author" content="Samuel Murillo">
<meta property="article:tag" content="aws">
<meta property="article:tag" content="python">
<meta property="article:tag" content="serverless">
<meta property="article:tag" content="terraform">
<meta property="article:tag" content="chalice">
<meta property="article:tag" content="lambda">
<meta name="twitter:card" content="summary">
    
    
    <!-- title -->
    <title>AWS Chalice + Terraform</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Back to top " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&text=AWS Chalice + Terraform"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&is_video=false&description=AWS Chalice + Terraform"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AWS Chalice + Terraform&body=Check out this article: https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&name=AWS Chalice + Terraform&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&t=AWS Chalice + Terraform"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to"><span class="toc-number">1.</span> <span class="toc-text">How-to</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Add-your-own-Terraform-code"><span class="toc-number">2.</span> <span class="toc-text">Add your own Terraform code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Referencing-Terraform-values-inside-Chalice"><span class="toc-number">3.</span> <span class="toc-text">Referencing Terraform values inside Chalice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Local-development-with-LocalStack"><span class="toc-number">4.</span> <span class="toc-text">Local development with LocalStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookiecutter-template"><span class="toc-number">5.</span> <span class="toc-text">Cookiecutter template</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        AWS Chalice + Terraform
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Samuel Murillo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-07-27T11:33:25.000Z" itemprop="datePublished">2021-07-27</time>
        
        (Updated: <time datetime="2021-08-10T02:08:35.931Z" itemprop="dateModified">2021-08-09</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/aws/" rel="tag">aws</a>, <a class="tag-link-link" href="/tags/chalice/" rel="tag">chalice</a>, <a class="tag-link-link" href="/tags/lambda/" rel="tag">lambda</a>, <a class="tag-link-link" href="/tags/python/" rel="tag">python</a>, <a class="tag-link-link" href="/tags/serverless/" rel="tag">serverless</a>, <a class="tag-link-link" href="/tags/terraform/" rel="tag">terraform</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a target="_blank" rel="noopener" href="https://aws.github.io/chalice/">AWS Chalice</a> is yet another Python serverless framework, like <a target="_blank" rel="noopener" href="https://github.com/zappa/Zappa">Zappa</a> and the <a href="serverless.com">Serverless Framework</a> (what a confusing name).</p>
<p>What makes Chalice special is that it has <a target="_blank" rel="noopener" href="https://aws.github.io/chalice/topics/tf">Terraform Support</a>, meaning that it is able to translate all its infrastructure to Terraform code, ready to be applied to AWS. This provides has all the benefits of the Serverless Framework, like configure your Lambda triggers and setup API Gateway, without fragmenting your infrastructure in CloudFormation and Terraform.</p>
<p>Having just one Infrastructure-as-Code tool in your project provides simplicity, more control over your application, and being able to reference serverless values directly in your Terraform without having to use a middleware data storage, like SSM. </p>
<h2 id="How-to"><a href="#How-to" class="headerlink" title="How-to"></a>How-to</h2><p>Let’s start by creating a sample Chalice project:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pyenv virtualenv chalice-tf</span><br><span class="line">pyenv activate chalice-tf</span><br><span class="line">pip install chalice</span><br><span class="line">chalice new-project chalice-tf</span><br><span class="line"><span class="built_in">cd</span> chalice-tf</span><br></pre></td></tr></table></figure>

<p>This creates a simple REST API with a hello world endpoint.</p>
<p>Now the fun part: let’s package and export this simple application to Terraform:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chalice package --pkg-format terraform .</span><br></pre></td></tr></table></figure>

<p>This does two main things:</p>
<ol>
<li>Package your Python code and requirements into a zip, located at <code>deployment.zip</code></li>
<li>Generate the Terraform code with all the infra required to run your app, located at <code>chalice.tf.json</code></li>
</ol>
<p>You will have to run this command every time you change your code, so make sure you add it to your CI/CD pipeline.</p>
<p>Now, let’s test it:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">terraform init &amp;&amp; terraform plan</span><br><span class="line">Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:</span><br><span class="line">  + create</span><br><span class="line"> &lt;= <span class="built_in">read</span> (data resources)</span><br><span class="line"></span><br><span class="line">... (omit plan output)</span><br><span class="line"></span><br><span class="line">Plan: 6 to add, 0 to change, 0 to destroy.</span><br></pre></td></tr></table></figure>

<p>We see a few notable resources here:<br><code>aws_api_gateway_deployment.rest_api</code> and <code>aws_api_gateway_rest_api.rest_api</code>:<br>API Gateway resources. This is one of the helpful parts of Chalice.</p>
<p><code>aws_lambda_function.api_handler</code>:<br>The lambda function itself, with its code in a zip file.</p>
<p><code>aws_iam_role.default-role</code> and <code>aws_iam_role_policy.default-role</code>:<br>The default IAM role, with a generated policy that allows accessing the resources created. This is helpful for a quick POC, but in a production environment you might want to customize the IAM policy yourself. More on this later.</p>
<h2 id="Add-your-own-Terraform-code"><a href="#Add-your-own-Terraform-code" class="headerlink" title="Add your own Terraform code"></a>Add your own Terraform code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br><span class="line">╷</span><br><span class="line">│ Error: Duplicate provider configuration</span><br><span class="line">│ </span><br><span class="line">│   on providers.tf line 9:</span><br><span class="line">│    9: provider &quot;aws&quot; &#123;</span><br><span class="line">│ </span><br><span class="line">│ A default (non-aliased) provider configuration for &quot;aws&quot; was already given at chalice.tf.json:122,12-13. If multiple configurations are required, set the &quot;alias&quot; argument for alternative configurations.</span><br></pre></td></tr></table></figure>

<p>If we peek at the auto-generated Terraform code at <code>chalice.tf.json</code>, looking for the provider key, we see a simple AWS provider definition with just a version constraint.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;provider&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;template&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;~&gt; 2&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;aws&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;&gt;= 2, &lt; 4&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;null&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;&gt;= 2, &lt; 4&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To fix this, we have two options: add an alias like the error suggests, this brings issues, or remove the provider defined by Chalice. This gives us flexibility</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;&lt; $(jq <span class="string">&#x27;del(.provider.aws)&#x27;</span> chalice.tf.json) &gt; chalice.tf.json</span><br></pre></td></tr></table></figure>

<h2 id="Referencing-Terraform-values-inside-Chalice"><a href="#Referencing-Terraform-values-inside-Chalice" class="headerlink" title="Referencing Terraform values inside Chalice"></a>Referencing Terraform values inside Chalice</h2><h2 id="Local-development-with-LocalStack"><a href="#Local-development-with-LocalStack" class="headerlink" title="Local development with LocalStack"></a>Local development with LocalStack</h2><h2 id="Cookiecutter-template"><a href="#Cookiecutter-template" class="headerlink" title="Cookiecutter template"></a>Cookiecutter template</h2><p>You can find my cookiecutter at … that includes Datadog, AWS Lambda Powertools</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to"><span class="toc-number">1.</span> <span class="toc-text">How-to</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Add-your-own-Terraform-code"><span class="toc-number">2.</span> <span class="toc-text">Add your own Terraform code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Referencing-Terraform-values-inside-Chalice"><span class="toc-number">3.</span> <span class="toc-text">Referencing Terraform values inside Chalice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Local-development-with-LocalStack"><span class="toc-number">4.</span> <span class="toc-text">Local development with LocalStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookiecutter-template"><span class="toc-number">5.</span> <span class="toc-text">Cookiecutter template</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&text=AWS Chalice + Terraform"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&is_video=false&description=AWS Chalice + Terraform"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=AWS Chalice + Terraform&body=Check out this article: https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&title=AWS Chalice + Terraform"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&name=AWS Chalice + Terraform&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://samuelmurillo.xyz/2021/07/27/AWS-Chalice-Terraform/&t=AWS Chalice + Terraform"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2021
    Samuel Murillo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
